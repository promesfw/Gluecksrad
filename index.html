<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Punkte-Glücksrad</title>
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        text-align: center;
        background: radial-gradient(circle at center, #fff8e7, #fceabb);
        margin: 0;
        padding: 20px;
    }
    h1 {
        color: #444;
        margin-bottom: 10px;
    }
    #wheel-container {
        position: relative;
        display: inline-block;
        margin-top: 50px;
    }
    #wheel {
        border-radius: 50%;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.3), 0 5px 15px rgba(0,0,0,0.4);
    }
    #pointer {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        width: 0; 
        height: 0; 
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-bottom: 30px solid #d32f2f;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
    }
    #spin-btn {
        padding: 12px 25px;
        font-size: 1.2rem;
        margin-top: 20px;
        border: none;
        background: linear-gradient(135deg, #ff6f61, #e53935);
        color: white;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #spin-btn:disabled {
        background: #bbb;
        cursor: not-allowed;
        box-shadow: none;
    }
    #result {
        margin-top: 25px;
        font-size: 1.4rem;
        background: white;
        display: inline-block;
        padding: 15px 30px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #prize-points {
        font-size: 3rem;
        display: block;
    }
</style>
</head>
<body>

<h1>Punkte-Glücksrad</h1>

<div id="wheel-container">
    <div id="pointer"></div>
    <canvas id="wheel" width="400" height="400"></canvas>
</div>
<br>
<button id="spin-btn">Drehen</button>

<div id="result">
    <h2>Dein Gewinn:</h2>
    <div id="prize-points">❓</div>
    <p id="prize-text">Noch nichts gedreht.</p>
</div>

<script>
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");

// Google Sheets Web-App URL hier eintragen:
const SHEETS_URL = "https://script.google.com/macros/s/DEINE-ID/exec";

// 12 Segmente: 1x +3, 2x +1, Rest 0
const segments = [
    { points: 3 },
    { points: 1 },
    { points: 1 },
    { points: 0 },
    { points: 0 },
    { points: 0 },
    { points: 0 },
    { points: 0 },
    { points: 0 },
    { points: 0 },
    { points: 0 },
    { points: 0 }
];

let angle = 0;
let spinning = false;
const segAngle = 2 * Math.PI / segments.length;

function drawWheel() {
    for (let i = 0; i < segments.length; i++) {
        const start = angle + i * segAngle;
        const grad = ctx.createRadialGradient(200, 200, 50, 200, 200, 200);
        grad.addColorStop(0, i % 2 === 0 ? "#ffe259" : "#ffa751");
        grad.addColorStop(1, i % 2 === 0 ? "#ffa751" : "#ffe259");

        ctx.beginPath();
        ctx.moveTo(200, 200);
        ctx.arc(200, 200, 200, start, start + segAngle);
        ctx.fillStyle = grad;
        ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.save();
        ctx.translate(200, 200);
        ctx.rotate(start + segAngle / 2);
        ctx.textAlign = "right";
        ctx.font = "bold 24px Arial";
        ctx.fillStyle = "#333";
        ctx.fillText("+" + segments[i].points, 170, 10);
        ctx.restore();
    }
}

drawWheel();

document.getElementById("spin-btn").addEventListener("click", spinWheel);

function spinWheel() {
    if (spinning) return;
    spinning = true;

    const today = new Date().toISOString().slice(0, 10);
    localStorage.setItem('lastSpinDate', today);

    const targetIndex = Math.floor(Math.random() * segments.length);
    const fullRotations = 5;
    const targetAngle = (3 * Math.PI / 2) - (targetIndex * segAngle) - segAngle/2;

    let totalRotation = fullRotations * 2 * Math.PI + normalizeAngle(targetAngle - angle);
    let currentRotation = 0;
    let speed = 0.3;

    function animate() {
        speed *= 0.99;
        currentRotation += speed;
        angle += speed;
        ctx.clearRect(0, 0, 400, 400);
        drawWheel();

        if (currentRotation < totalRotation) {
            requestAnimationFrame(animate);
        } else {
            let t = 0;
            const overshoot = 0.08;
            function wobble() {
                const decay = Math.exp(-3 * t);
                const wobbleAngle = overshoot * Math.sin(t * 12) * decay;
                ctx.clearRect(0, 0, 400, 400);
                angle = targetAngle + wobbleAngle;
                drawWheel();
                t += 0.05;
                if (decay > 0.01) {
                    requestAnimationFrame(wobble);
                } else {
                    angle = targetAngle;
                    drawWheel();
                    spinning = false;
                    showResult(targetIndex);
                }
            }
            wobble();
        }
    }
    animate();
}

function normalizeAngle(a) {
    a = a % (2 * Math.PI);
    if (a < 0) a += 2 * Math.PI;
    return a;
}

function showResult(index) {
    const prize = segments[index];
    document.getElementById("prize-points").textContent = "+" + prize.points;
    let feedback;
    if (prize.points === 0) feedback = "leider keine Punkte";
    else if (prize.points === 1) feedback = "Gratuliere! Du erhältst einen Punkt.";
    else feedback = "Dein Glückstag – 3 Punkte!";
    document.getElementById("prize-text").textContent = feedback;

    const btn = document.getElementById("spin-btn");
    btn.disabled = true;
    btn.textContent = "Heute gedreht";

    // --- Ergebnis an Google Sheets senden ---
    if (SHEETS_URL && !SHEETS_URL.includes("DEINE-ID")) {
        fetch(SHEETS_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                date: new Date().toISOString().slice(0, 10),
                points: prize.points,
                user: localStorage.getItem('gluecksrad_user') || 'anonymous',
                angle: index
            })
        }).catch(err => console.error("Sheets POST fehlgeschlagen:", err));
    }
}

// Tägliche Limitierung
const today = new Date().toISOString().slice(0, 10);
const lastSpinDate = localStorage.getItem('lastSpinDate');
if (lastSpinDate === today) {
    const btn = document.getElementById("spin-btn");
    btn.disabled = true;
    btn.textContent = "Heute gedreht";
}
</script>
</body>
</html>
