<!Doctype Html>
<Html Lang="De">
<Head>
<Meta Charset="Utf-8" />
<Meta Name="Viewport" Content="Width=Device-Width,Initial-Scale=1" />
<Title>Punkte-Glücksrad</Title>
<Style>
  :Root { --Bg1:#Fff8e7; --Bg2:#Fceabb; --Btn1:#Ff6f61; --Btn2:#E53935; }
  Html,Body { Height:100%; Margin:0; Font-Family: "Segoe Ui", Roboto, Arial, Sans-Serif; Background: Radial-Gradient(Circle At Center, Var(--Bg1), Var(--Bg2)); }
  .Wrap { Max-Width:520px; Margin:18px Auto; Padding:12px; Text-Align:Center; }
  H1 { Font-Weight:600; Color:#333; Margin:8px 0 18px; }
  #Wheel-Container { Position:Relative; Display:Inline-Block; }
  Canvas { Display:Block; Width: Min(420px, 84vw); Height: Auto; Border-Radius:50%; Box-Shadow: Inset 0 0 18px Rgba(0,0,0,0.18), 0 6px 18px Rgba(0,0,0,0.18); }
  #Pointer {
    Position:Absolute; Bottom:-18px; Left:50%; Transform:Translatex(-50%) Rotate(0);
    Width:0;Height:0;Border-Left:20px Solid Transparent;Border-Right:20px Solid Transparent;Border-Top:34px Solid #D32f2f;
    Filter: Drop-Shadow(0 3px 6px Rgba(0,0,0,0.25));
  }
  #Spin-Btn {
    Margin-Top:18px;
    Padding:12px 26px; Font-Size:18px; Color:#Fff; Border:0; Border-Radius:999px;
    Background: Linear-Gradient(135deg, Var(--Btn1), Var(--Btn2)); Box-Shadow:0 6px 14px Rgba(0,0,0,0.18);
    Cursor:Pointer; Touch-Action:Manipulation;
  }
  #Spin-Btn[Disabled] { Background:#Bdbdbd; Box-Shadow:None; Cursor:Not-Allowed; }
  #Result { Margin-Top:18px; Display:Inline-Block; Background:#Fff; Padding:14px 22px; Border-Radius:12px; Box-Shadow:0 6px 14px Rgba(0,0,0,0.12); Min-Width:220px; }
  #Prize-Points { Font-Size:36px; Font-Weight:700; Margin-Bottom:6px; Color:#222; }
  #Prize-Text { Margin:0; Color:#444; Font-Size:15px; }
  @Media (Max-Width:420px){ #Prize-Points { Font-Size:28px; } #Spin-Btn { Font-Size:16px; Padding:10px 20px; } }
</Style>
</Head>
<Body>
  <Div Class="Wrap">
    <H1>Punkte-Glücksrad</H1>

    <Div Id="Wheel-Container">
      <Canvas Id="Wheel" Aria-Label="Glücksrad"></Canvas>
      <Div Id="Pointer" Aria-Hidden="True"></Div>
    </Div>

    <Div>
      <Button Id="Spin-Btn" Type="Button">Drehen</Button>
    </Div>

    <Div Id="Result">
      <Div Id="Prize-Points">–</Div>
      <P Id="Prize-Text">Noch Nichts Gedreht.</P>
    </Div>
  </Div>

<Script>
/* Punkte-Glücksrad V3
   - 12 Segmente: 1×+3, 2×+1, 9×0 (Zufällig Verteilt Beim Laden)
   - Responsive Canvas (Devicepixelratio)
   - Zeitbasiertes Tweening + Wobble Am Ende
   - Mobile-Friendly
   - Setze Hier_Deine_Google_Script_Url Ein Wenn Du Die Daten An Sheets Senden Willst
*/

Const Canvas = Document.Getelementbyid('Wheel');
Const Ctx = Canvas.Getcontext('2d');
Const Spinbtn = Document.Getelementbyid('Spin-Btn');
Const Prizepointsel = Document.Getelementbyid('Prize-Points');
Const Prizetextel = Document.Getelementbyid('Prize-Text');

Let Dpr = Math.Max(1, Window.Devicepixelratio || 1);
Let Csssize = 360; // Initial Fallback, Will Be Replaced By Resize()
Let Center = { X: 0, Y: 0 };
Let Radius = 0;

Const Seg_Count = 12;
Let Segments = []; // Wird Mit Punkten Gefüllt
Const Segangle = 2 * Math.Pi / Seg_Count;

Let Angle = 0;        // Aktuelle Rotation (Radian)
Let Isspinning = False;
Let Lasttargetindex = Null;

// Google Script Url - Bitte Hier Deine Webapp-Url Eintragen:
Const Sheets_Url = "Hier_Deine_Google_Script_Url"; // Leave As Placeholder Or Fill

// --- Hilfsfunktionen ---
Function Shufflearray(A){
  For(Let I=A.Length-1;I>0;I--){
    Const J=Math.Floor(Math.Random()*(I+1));
    [A[I],A[J]]=[A[J],A[I]];
  }
}

Function Generatesegments(){
  // 1x +3, 2x +1, Rest 0
  Const Arr = Array(Seg_Count).Fill(0);
  // Set +3
  Let Indices = Array.From({Length:Seg_Count}, (_,I)=>I);
  Shufflearray(Indices);
  Arr[Indices[0]] = 3;
  Arr[Indices[1]] = 1;
  Arr[Indices[2]] = 1;
  // Rest 0 Already
  Return Arr.Map(P => ({ Points: P }));
}

Function Normalizeangle(A){
  Const Mod = 2*Math.Pi;
  A = A % Mod;
  If (A < 0) A += Mod;
  Return A;
}

Function Easeoutcubic(T){ Return 1 - Math.Pow(1-T,3); }

// --- Canvas Setup & Responsive Scaling ---
Function Resizecanvas(){
  // Css Size = Computed Width Of Canvas (Responsive)
  Const Computed = Math.Min(420, Math.Max(240, Math.Round(Window.Innerwidth * 0.84)));
  Csssize = Computed;
  Canvas.Style.Width = Csssize + 'Px';
  Canvas.Style.Height = Csssize + 'Px';

  Dpr = Math.Max(1, Window.Devicepixelratio || 1);
  Canvas.Width = Math.Round(Csssize * Dpr);
  Canvas.Height = Math.Round(Csssize * Dpr);

  // Set Transform So We Can Draw In Css Pixels
  Ctx.Settransform(Dpr, 0, 0, Dpr, 0, 0);

  Center.X = Csssize / 2;
  Center.Y = Csssize / 2;
  Radius = Csssize / 2;

  Drawwheel();
}

Window.Addeventlistener('Resize', () => { Resizecanvas(); });

// --- Zeichnen ---
Function Drawwheel(){
  Ctx.Clearrect(0, 0, Csssize, Csssize);

  For(Let I=0;I<Seg_Count;I++){
    Const Start = Angle + I * Segangle;
    // Radial Gradient
    Const Grad = Ctx.Createradialgradient(Center.X - Radius*0.2, Center.Y - Radius*0.2, Radius*0.05, Center.X, Center.Y, Radius);
    Const C1 = (I % 2 === 0) ? '#Ffe259' : '#Ffa751';
    Const C2 = (I % 2 === 0) ? '#Ffa751' : '#Ffe259';
    Grad.Addcolorstop(0, C1);
    Grad.Addcolorstop(1, C2);

    Ctx.Beginpath();
    Ctx.Moveto(Center.X, Center.Y);
    Ctx.Arc(Center.X, Center.Y, Radius, Start, Start + Segangle);
    Ctx.Closepath();
    Ctx.Fillstyle = Grad;
    Ctx.Fill();
    Ctx.Strokestyle = '#Ffffff';
    Ctx.Linewidth = Math.Max(1, Csssize * 0.006);
    Ctx.Stroke();

    // Punkteschrift In Der Mitte Des Segments
    Ctx.Save();
    Ctx.Translate(Center.X, Center.Y);
    Ctx.Rotate(Start + Segangle / 2);
    Ctx.Textalign = 'Right';
    Ctx.Font = `Bold ${Math.Max(14, Math.Round(Csssize*0.08))}Px Arial`;
    Ctx.Fillstyle = '#222';
    Ctx.Filltext((Segments[I].Points>0? '+' : '') + Segments[I].Points, Radius * 0.78, Math.Round(Csssize*0.02));
    Ctx.Restore();
  }

  // Optional: Inner Circle To Create "Mechanical" Look
  Ctx.Beginpath();
  Ctx.Arc(Center.X, Center.Y, Radius*0.14, 0, 2*Math.Pi);
  Ctx.Fillstyle = '#Fff7f2';
  Ctx.Fill();
  Ctx.Strokestyle = 'Rgba(0,0,0,0.08)';
  Ctx.Stroke();
}

// --- Spin-Logik (Time-Based Tween + Wobble) ---
Function Spin(){
  If (Isspinning) Return;
  If (Spinbtn.Disabled) Return;
  Isspinning = True;
  Spinbtn.Disabled = True;
  Spinbtn.Textcontent = 'Dreht...';

  // Zufälliges Zielsegment
  Const Targetindex = Math.Floor(Math.Random() * Seg_Count);
  Lasttargetindex = Targetindex;

  // Berechne Zielwinkel So, Dass Die Mitte Des Segments Auf Den Pointer (Oben, Angle = 3π/2) Zeigt
  Const Desiredmidangle = (3*Math.Pi/2) - (Targetindex * Segangle) - Segangle/2;
  Const Currentnorm = Normalizeangle(Angle);
  Const Desirednorm = Normalizeangle(Desiredmidangle);

  // Delta Im Bereich [0, 2π)
  Const Delta = (Desirednorm - Currentnorm + 2*Math.Pi) % (2*Math.Pi);

  // Vollrotationen Zufällig (Mehr Dreh = Besseres Feeling)
  Const Fullrots = 4 + Math.Floor(Math.Random() * 3); // Zwischen 4 Und 6 Volle Runden
  Const Finalangle = Angle + Fullrots * 2 * Math.Pi + Delta;

  Const Duration = 3800 + Math.Floor(Math.Random() * 600); // Ms

  // Tweening
  Const Startangle = Angle;
  Const Starttime = Performance.Now();

  Function Frame(Now){
    Const Elapsed = Now - Starttime;
    Const T = Math.Min(1, Elapsed / Duration);
    Const Eased = Easeoutcubic(T);
    Angle = Startangle + (Finalangle - Startangle) * Eased;
    Drawwheel();
    If (T < 1) {
      Requestanimationframe(Frame);
    } Else {
      // Wobble (Abklingende Schwingung) Vor Dem Einrasten
      Startwobble(Desiredmidangle, () => {
        // Endgültig Einrasten, Ergebnis Anzeigen
        Angle = Desiredmidangle;
        Drawwheel();
        Onspincomplete(Targetindex);
      });
    }
  }
  Requestanimationframe(Frame);
}

Function Startwobble(Targetangle, Cb){
  Const Wobbleduration = 900; // Ms
  Const Amplitude = 0.12; // Rad (Max)
  Const Frequency = 12;    // Schwingungen Pro Sekunde Ungefähr => Beeinflusst Wahrnehmung
  Const T0 = Performance.Now();
  Function Wob(Now){
    Const Elapsed = Now - T0;
    Const T = Elapsed / Wobbleduration;
    If (T >= 1) {
      Cb();
      Return;
    }
    Const Decay = Math.Exp(-4 * T); // Decay Von 1 -> 0
    Const W = Amplitude * Decay * Math.Sin(Frequency * 2 * Math.Pi * T);
    Angle = Targetangle + W;
    Drawwheel();
    Requestanimationframe(Wob);
  }
  Requestanimationframe(Wob);
}

// --- Ergebnis / Ui / Sheets Senden ---
Function Onspincomplete(Index){
  Isspinning = False;
  Const Points = Segments[Index].Points;
  // Feedback Texte (Genau Wie Gewünscht)
  Let Feedback;
  If (Points === 0) Feedback = "Leider Keine Punkte";
  Else If (Points === 1) Feedback = "Gratuliere! Du Erhältst Einen Punkt.";
  Else Feedback = "Dein Glückstag - 3 Punkte!";

  Prizepointsel.Textcontent = (Points > 0 ? "+" : "") + Points;
  Prizetextel.Textcontent = Feedback;

  // Setze Button-Text & Sperre (Und Speichere Datum)
  Const Today = New Date().Toisostring().Slice(0,10);
  Localstorage.Setitem('Gluecksrad_Lastspindate', Today);
  Localstorage.Setitem('Gluecksrad_Lastpoints', Points);
  Localstorage.Setitem('Gluecksrad_Lastfeedback', Feedback);

  Spinbtn.Disabled = True;
  Spinbtn.Textcontent = "Heute Gedreht";

  // Ergebnis An Google Sheets Senden (Optional)
  If (Sheets_Url && Sheets_Url.Indexof('Hier_Deine') === -1) {
    Try {
      Fetch(Sheets_Url, {
        Method: 'Post',
        Headers: { 'Content-Type': 'Application/Json' },
        Body: Json.Stringify({
          Date: Today,
          Points: Points,
          User: (Localstorage.Getitem('Gluecksrad_User') || 'Anonymous'),
          Angle: Lasttargetindex
        })
      }).Catch(Err => {
        // Fehler Ignorieren / Optional Logging
        Console.Warn('Sheets Post Failed:', Err);
      });
    } Catch(E){ Console.Warn('Sheets Post Exception', E); }
  }
}

// --- Initialisierung / Event-Handling ---
Function Restorestate(){
  Const Lastdate = Localstorage.Getitem('Gluecksrad_Lastspindate');
  Const Today = New Date().Toisostring().Slice(0,10);
  If (Lastdate === Today) {
    Spinbtn.Disabled = True;
    Spinbtn.Textcontent = 'Heute Gedreht';
    Const Pts = Localstorage.Getitem('Gluecksrad_Lastpoints');
    Const Fb = Localstorage.Getitem('Gluecksrad_Lastfeedback');
    If (Pts !== Null) Prizepointsel.Textcontent = (Number(Pts) > 0 ? "+" : "") + Pts;
    If (Fb) Prizetextel.Textcontent = Fb;
  }
}

Function Attachhandlers(){
  // Sychronisierte Unterstützung Für Click / Touch
  Spinbtn.Addeventlistener('Click', () => { If (!Isspinning) Spin(); });
  Spinbtn.Addeventlistener('Touchstart', (E) => { E.Preventdefault(); If (!Isspinning) Spin(); }, {Passive:False});
}

// --- Start ---
Function Init(){
  Segments = Generatesegments();
  Resizecanvas();
  Attachhandlers();
  Restorestate();
}

Init();

</Script>
</Body>
</Html>
